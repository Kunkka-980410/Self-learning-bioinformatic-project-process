!Sample_geo_accession	"GSM1725780"	"GSM1725781"	"GSM1725782"	"GSM1725783"	"GSM1725784"	"GSM1725785"	"GSM1725786"	"GSM1725787"	"GSM1725788"	"GSM1725789"	"GSM1725790"	"GSM1725791"	"GSM1725792"	"GSM1725793"	"GSM1725794"	"GSM1725795"	"GSM1725796"	"GSM1725797"	"GSM1725798"	"GSM1725799"	"GSM1725800"	"GSM1725801"	"GSM1725802"	"GSM1725803"	"GSM1725804"	"GSM1725805"	"GSM1725806"	"GSM1725807"	"GSM1725808"	"GSM1725809"	"GSM1725810"	"GSM1725811"	"GSM1725812"	"GSM1725813"	"GSM1725814"	"GSM1725815"	"GSM1725816"	"GSM1725817"	"GSM1725818"	"GSM1725819"	"GSM1725820"	"GSM1725821"	"GSM1725822"	"GSM1725823"	"GSM1725824"	"GSM1725825"	"GSM1725826"	"GSM1725827"
映射为!Sample_characteristics_ch1	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"
，再映射为!Sample_characteristics_ch1	"thompson grade: III"	"thompson grade: III"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: III"	"thompson grade: III"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: V"	"thompson grade: V"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: V"	"thompson grade: V"	"thompson grade: III"	"thompson grade: III"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: I"	"thompson grade: I"	"thompson grade: II"	"thompson grade: II"	"thompson grade: V"	"thompson grade: V"	"thompson grade: II"	"thompson grade: II"	"thompson grade: V"	"thompson grade: V"	"thompson grade: I"	"thompson grade: I"	"thompson grade: I-II"	"thompson grade: I-II"	"thompson grade: I"	"thompson grade: I"	"thompson grade: III"	"thompson grade: III"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: III"	"thompson grade: III"	"thompson grade: I"	"thompson grade: I"	"thompson grade: III"	"thompson grade: III"	"thompson grade: I-II"	"thompson grade: I-II"
，需要把新的列索引变成托马逊等级+AF/NP的样子
第一步：提取并解析元数据
首先，我们需要从您提供的元数据中提取分组信息：
```python
import pandas as pd
import numpy as np

# 假设您已经从文件中读取了元数据行
# 这里我们直接使用您提供的字符串来创建示例数据

# 您提供的元数据行
tissue_data = '"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"	"tissue: Nucleus pulposus"	"tissue: Annulus fibrosus"'

grade_data = '"thompson grade: III"	"thompson grade: III"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: III"	"thompson grade: III"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: V"	"thompson grade: V"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: V"	"thompson grade: V"	"thompson grade: III"	"thompson grade: III"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: I"	"thompson grade: I"	"thompson grade: II"	"thompson grade: II"	"thompson grade: V"	"thompson grade: V"	"thompson grade: II"	"thompson grade: II"	"thompson grade: V"	"thompson grade: V"	"thompson grade: I"	"thompson grade: I"	"thompson grade: I-II"	"thompson grade: I-II"	"thompson grade: I"	"thompson grade: I"	"thompson grade: III"	"thompson grade: III"	"thompson grade: IV"	"thompson grade: IV"	"thompson grade: III"	"thompson grade: III"	"thompson grade: I"	"thompson grade: I"	"thompson grade: III"	"thompson grade: III"	"thompson grade: I-II"	"thompson grade: I-II"'

# 样本ID列表（从您之前的表达矩阵中获取）
sample_ids = ["GSM1725780", "GSM1725781", "GSM1725782", "GSM1725783", "GSM1725784", "GSM1725785", "GSM1725786", "GSM1725787", "GSM1725788", "GSM1725789", "GSM1725790", "GSM1725791", "GSM1725792", "GSM1725793", "GSM1725794", "GSM1725795", "GSM1725796", "GSM1725797", "GSM1725798", "GSM1725799", "GSM1725800", "GSM1725801", "GSM1725802", "GSM1725803", "GSM1725804", "GSM1725805", "GSM1725806", "GSM1725807", "GSM1725808", "GSM1725809", "GSM1725810", "GSM1725811", "GSM1725812", "GSM1725813", "GSM1725814", "GSM1725815", "GSM1725816", "GSM1725817", "GSM1725818", "GSM1725819", "GSM1725820", "GSM1725821", "GSM1725822", "GSM1725823", "GSM1725824", "GSM1725825", "GSM1725826", "GSM1725827"]
```
第二步：解析元数据并创建映射
```python
# 解析组织类型数据
tissue_values = [x.replace('"', '').replace('tissue: ', '') for x in tissue_data.split('\t')]
tissue_mapping = dict(zip(sample_ids, tissue_values))

# 解析Thompson等级数据
grade_values = [x.replace('"', '').replace('thompson grade: ', '') for x in grade_data.split('\t')]
grade_mapping = dict(zip(sample_ids, grade_values))

print("组织类型映射示例:")
for i, (sample, tissue) in enumerate(tissue_mapping.items()):
    if i < 5:  # 只显示前5个
        print(f"{sample}: {tissue}")

print("\nThompson等级映射示例:")
for i, (sample, grade) in enumerate(grade_mapping.items()):
    if i < 5:  # 只显示前5个
        print(f"{sample}: {grade}")
```
第三步：创建新的列名
# 创建新的列名：Thompson等级 + 组织类型
```python
new_column_names = {}
for sample_id in sample_ids:
    tissue = tissue_mapping[sample_id]
    grade = grade_mapping[sample_id]
    
    # 简写组织类型
    tissue_short = "AF" if "Annulus" in tissue else "NP"
    
    # 创建新列名
    new_name = f"Grade{grade}_{tissue_short}"
    new_column_names[sample_id] = new_name

print("新的列名映射:")
for i, (sample, new_name) in enumerate(new_column_names.items()):
    if i < 10:  # 只显示前10个
        print(f"{sample} -> {new_name}")
```
第四步：应用到表达矩阵
假设您已经读取了表达矩阵数据：
```python
# 读取表达矩阵数据
expr_df = pd.read_csv("your_expression_data.txt", 
                      sep="\t",
                      comment="!",
                      header=0,
                      index_col=0)

print("原始列名:", expr_df.columns[:5].tolist())

# 重命名列
expr_df_renamed = expr_df.rename(columns=new_column_names)

print("重命名后的列名:", expr_df_renamed.columns[:5].tolist())
print("重命名后的数据形状:", expr_df_renamed.shape)
print("\n重命名后的数据前5行:")
print(expr_df_renamed.iloc[:5, :5])
```
第五步：创建分组信息用于分析
```python
# 创建分组信息（用于后续的差异分析）
group_info = pd.DataFrame({
    'sample_id': sample_ids,
    'tissue': [tissue_mapping[s] for s in sample_ids],
    'grade': [grade_mapping[s] for s in sample_ids],
    'new_name': [new_column_names[s] for s in sample_ids]
})

print("样本分组信息:")
print(group_info.head(10))

# 统计各组的样本数
print("\n各组织类型样本数:")
print(group_info['tissue'].value_counts())

print("\n各Thompson等级样本数:")
print(group_info['grade'].value_counts())

print("\n各组合分组样本数:")
print(group_info.groupby(['grade', 'tissue']).size())
```
### 完整的一站式函数
```python
def process_geo_metadata(expression_df, tissue_str, grade_str, sample_ids):
    """
    处理GEO元数据并重命名表达矩阵列名
    """
    # 解析元数据
    tissue_values = [x.replace('"', '').replace('tissue: ', '') for x in tissue_str.split('\t')]
    grade_values = [x.replace('"', '').replace('thompson grade: ', '') for x in grade_str.split('\t')]
    
    # 创建映射
    tissue_map = dict(zip(sample_ids, tissue_values))
    grade_map = dict(zip(sample_ids, grade_values))
    
    # 创建新列名
    new_cols = {}
    for sample in sample_ids:
        tissue_short = "AF" if "Annulus" in tissue_map[sample] else "NP"
        new_cols[sample] = f"Grade{grade_map[sample]}_{tissue_short}"
    
    # 重命名表达矩阵
    expr_renamed = expression_df.rename(columns=new_cols)
    
    # 创建分组信息
    sample_info = pd.DataFrame({
        'sample_id': sample_ids,
        'tissue': [tissue_map[s] for s in sample_ids],
        'grade': [grade_map[s] for s in sample_ids],
        'group_name': [new_cols[s] for s in sample_ids]
    })
    
    return expr_renamed, sample_info

# 使用函数
expr_df_renamed, sample_info = process_geo_metadata(expr_df, tissue_data, grade_data, sample_ids)
```
